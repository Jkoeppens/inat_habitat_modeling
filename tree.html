
<!DOCTYPE html>
<meta charset="utf-8">
<title>Decision Tree – ML Visualisierung</title>

<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; background: #f7f7f7; }
  .label { font-size: 12px; text-anchor: middle; }
  .edge-label { font-size: 11px; fill: #666; }
</style>

<svg id="tree-svg"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>

<script>

// -------------------------
// Eingebettete Daten
// -------------------------
const treeData = {"feature": "m12_ndvi_mean", "threshold": 0.480010003, "yes": {"feature": "m12_geary_ndwi", "threshold": 0.0545174778, "yes": {"feature": "m10_moran_ndwi", "threshold": 0.424680263, "yes": {"feature": "m09_geary_ndwi", "threshold": 0.0917379409, "yes": {"leaf": 0.0795388147, "suit": 0.5198742270489444}, "no": {"leaf": -0.00331585458, "suit": 0.4991710371145296}, "label": "Heterogenität (Sommer, Geary)", "palette": ["#f7f4f9", "#998ec3", "#542788"], "range": [0.0, 1.5]}, "no": {"feature": "m09_ndvi_mean", "threshold": 0.850283265, "yes": {"leaf": -0.0452734791, "suit": 0.48868356308929806}, "no": {"leaf": 0.0463396348, "suit": 0.5115828360625808}, "label": "Vegetationsdichte (Sommer, NDVI)", "palette": ["#f2f2f2", "#a3c586", "#2f6b3a"], "range": [0.0, 1.0]}, "label": "Cluster (Herbst, Moran)", "palette": ["#fee8c8", "#fdbb84", "#e34a33"], "range": [-0.2, 4.0]}, "no": {"feature": "m09_geary_ndwi", "threshold": 0.028088253, "yes": {"feature": "m12_geary_ndwi", "threshold": 0.139125019, "yes": {"leaf": -0.0301068556, "suit": 0.4924738545805336}, "no": {"leaf": 0.0605578534, "suit": 0.515134838358461}, "label": "Heterogenität (Herbst, Geary)", "palette": ["#f7f4f9", "#998ec3", "#542788"], "range": [0.0, 1.5]}, "no": {"feature": "m07_moran_ndvi", "threshold": -0.210373208, "yes": {"leaf": 0.0634030923, "suit": 0.5158454652629783}, "no": {"leaf": -0.0631230697, "suit": 0.4842244703891457}, "label": "Cluster (Sommer, Moran)", "palette": ["#fee8c8", "#fdbb84", "#e34a33"], "range": [-0.2, 4.0]}, "label": "Heterogenität (Sommer, Geary)", "palette": ["#f7f4f9", "#998ec3", "#542788"], "range": [0.0, 1.5]}, "label": "Heterogenität (Herbst, Geary)", "palette": ["#f7f4f9", "#998ec3", "#542788"], "range": [0.0, 1.5]}, "no": {"feature": "m11_geary_ndwi", "threshold": 0.159952193, "yes": {"feature": "m10_ndvi_mean", "threshold": 0.797601819, "yes": {"feature": "m11_moran_ndwi", "threshold": 0.822871506, "yes": {"leaf": 0.0659800693, "suit": 0.5164890358534368}, "no": {"leaf": -0.00489215972, "suit": 0.4987769625092685}, "label": "Cluster (Herbst, Moran)", "palette": ["#fee8c8", "#fdbb84", "#e34a33"], "range": [-0.2, 4.0]}, "no": {"leaf": -0.0576050952, "suit": 0.48560270724758964}, "label": "Vegetationsdichte (Herbst, NDVI)", "palette": ["#f2f2f2", "#a3c586", "#2f6b3a"], "range": [0.0, 1.0]}, "no": {"feature": "m09_moran_ndwi", "threshold": 0.359485358, "yes": {"leaf": -0.0806633756, "suit": 0.47984508321356545}, "no": {"feature": "m12_geary_ndwi", "threshold": 0.133171022, "yes": {"leaf": 0.0674301907, "suit": 0.5168511632100665}, "no": {"leaf": -0.0276072063, "suit": 0.49309863674677445}, "label": "Heterogenität (Herbst, Geary)", "palette": ["#f7f4f9", "#998ec3", "#542788"], "range": [0.0, 1.5]}, "label": "Cluster (Sommer, Moran)", "palette": ["#fee8c8", "#fdbb84", "#e34a33"], "range": [-0.2, 4.0]}, "label": "Heterogenität (Herbst, Geary)", "palette": ["#f7f4f9", "#998ec3", "#542788"], "range": [0.0, 1.5]}, "label": "Vegetationsdichte (Herbst, NDVI)", "palette": ["#f2f2f2", "#a3c586", "#2f6b3a"], "range": [0.0, 1.0]};
const viridis = ["#440154", "#482475", "#414487", "#355f8d", "#2a788e", "#21918c", "#22a884", "#42be71", "#7ad151", "#bddf26", "#fde725"];

// -------------------------
// SVG Setup
// -------------------------
const svg = d3.select("#tree-svg");

const dx = 260;      // horizontal spacing
const dy = 240;      // vertical spacing
const nodeW = 240;
const nodeH = 70;

// ---- Baumhierarchie ----
const root = d3.hierarchy(treeData, function(d){
    const c = [];
    if (d.yes) c.push(Object.assign({ "_edge": "Ja" }, d.yes));
    if (d.no)  c.push(Object.assign({ "_edge": "Nein" }, d.no));
    return c.length ? c : null;
});

d3.tree().nodeSize([dx, dy])(root);

// ---- Dynamische SVG-Ausdehnung ----
let minX = Infinity, maxX = -Infinity;
let minY = Infinity, maxY = -Infinity;

root.each(function(d){
    if (d.x < minX) minX = d.x;
    if (d.x > maxX) maxX = d.x;
    if (d.y < minY) minY = d.y;
    if (d.y > maxY) maxY = d.y;
});

const pad = 300;

svg.attr("width",  (maxX - minX) + 2*pad);
svg.attr("height", (maxY - minY) + 3*pad);

const xOffset = pad - minX;
const yOffset = pad - minY;

const g = svg.append("g")
    .attr("transform", "translate(" + xOffset + "," + yOffset + ")");

// -------------------------
// Links zeichnen
// -------------------------
g.append("g")
  .selectAll("path")
  .data(root.links())
  .join("path")
    .attr("fill", "none")
    .attr("stroke", "#444")
    .attr("stroke-width", 1.4)
    .attr("d", d3.linkVertical()
          .x(function(d){ return d.x; })
          .y(function(d){ return d.y; })
     );

// Edge-Labels
g.append("g")
  .selectAll("text")
  .data(root.links())
  .join("text")
    .attr("class", "edge-label")
    .attr("x", function(d){ return (d.source.x + d.target.x)/2; })
    .attr("y", function(d){ return (d.source.y + d.target.y)/2 - 4; })
    .attr("text-anchor", "middle")
    .text(function(d){ return d.target.data._edge; });


// -------------------------
// Knoten zeichnen
// -------------------------
const defs = svg.append("defs");

function thresholdX(d){
    const r = d.data.range;
    if (!r || d.data.threshold == null) return 0;
    const min = r[0];
    const max = r[1];
    const t = d.data.threshold;
    const rel = Math.max(0, Math.min(1, (t - min)/(max - min)));
    return -nodeW/2 + rel * nodeW;
}

const node = g.append("g")
  .selectAll("g")
  .data(root.descendants())
  .join("g")
    .attr("transform", function(d){
        return "translate(" + d.x + "," + d.y + ")";
    });

node.each(function(d){
    const gNode = d3.select(this);

    // ----------- Leaf -----------
    if (d.data.leaf !== undefined){
        const s = d.data.suit;

        const color = viridis[Math.floor(s * (viridis.length-1))];

        gNode.append("rect")
            .attr("x", -90)
            .attr("y", -25)
            .attr("width", 180)
            .attr("height", 50)
            .attr("rx", 10)
            .attr("fill", color)
            .attr("stroke", "#333");

        gNode.append("text")
            .attr("class", "label")
            .attr("dy", -2)
            .text("Leaf: " + d.data.leaf.toFixed(3));

        gNode.append("text")
            .attr("class", "label")
            .attr("dy", 14)
            .text("suit = " + s.toFixed(3));

        return;
    }

    // ----------- Decision Node -----------
    const pal = d.data.palette || ["#ddd", "#aaa", "#666"];
    const gradId = "g" + Math.random().toString(36).slice(2);

    const grad = defs.append("linearGradient")
         .attr("id", gradId)
         .attr("x1", "0%")
         .attr("x2", "100%")
         .attr("y1", "0%")
         .attr("y2", "0%");

    pal.forEach(function(c,i){
        grad.append("stop")
            .attr("offset", (i/(pal.length-1))*100 + "%")
            .attr("stop-color", c);
    });

    gNode.append("rect")
        .attr("x", -nodeW/2)
        .attr("y", -nodeH/2)
        .attr("width", nodeW)
        .attr("height", nodeH)
        .attr("rx", 10)
        .attr("fill", "url(#" + gradId + ")")
        .attr("stroke", "#333");

    // Threshold-Linie
    const tx = thresholdX(d);
    gNode.append("line")
        .attr("x1", tx)
        .attr("x2", tx)
        .attr("y1", -nodeH/2)
        .attr("y2", nodeH/2)
        .attr("stroke", "black")
        .attr("stroke-width", 2);

    gNode.append("text")
        .attr("class", "label")
        .attr("y", -nodeH/2 - 8)
        .text(d.data.label);

    gNode.append("text")
        .attr("class", "label")
        .attr("y", nodeH/2 + 14)
        .text("Schwelle: " + d.data.threshold.toFixed(3));
});


// -------------------------
// Suitability-Skala unten
// -------------------------
let maxYleaf = -Infinity;
root.leaves().forEach(function(d){
    if (d.y > maxYleaf) maxYleaf = d.y;
});

const barY = yOffset + maxYleaf + 200;
const barX = 100;
const barW = svg.attr("width") - 200;

const gradSuit = defs.append("linearGradient")
  .attr("id", "gradSuit")
  .attr("x1", "0%")
  .attr("x2", "100%")
  .attr("y1", "0%")
  .attr("y2", "0%");

viridis.forEach(function(c,i){
    gradSuit.append("stop")
        .attr("offset", (i/(viridis.length-1))*100 + "%")
        .attr("stop-color", c);
});

svg.append("rect")
  .attr("x", barX)
  .attr("y", barY)
  .attr("width", barW)
  .attr("height", 40)
  .attr("fill", "url(#gradSuit)")
  .attr("stroke", "#333");

svg.append("text")
  .attr("x", barX)
  .attr("y", barY - 10)
  .text("Suitability (sigmoid(Leaf))  —  0 → 1");

</script>
